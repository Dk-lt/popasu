@page "/materialitems"
@inject MaterialItemsApi MaterialItemsApi
@inject IJSRuntime JSRuntime

<PageTitle>–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</PageTitle>

<div class="classrooms-container">
    <div class="classrooms-header">
        <div class="header-content">
            <h1 class="page-title">
                <span class="title-icon">üì¶</span>
                –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
            </h1>
            <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ –∏ –∏–º—É—â–µ—Å—Ç–≤–æ–º</p>
        </div>
        <button class="btn btn-create" @onclick="ShowCreateForm">
            <span class="btn-icon">+</span>
            –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger modern-alert" role="alert">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div class="alert-content">
                <strong>–û—à–∏–±–∫–∞:</strong> @errorMessage
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success modern-alert" role="alert">
            <span class="alert-icon">‚úì</span>
            <div class="alert-content">
                <strong>–£—Å–ø–µ—à–Ω–æ:</strong> @successMessage
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
    }

    @if (showCreateForm)
    {
        <div class="form-card modern-card">
            <div class="form-card-header">
                <h3 class="form-card-title">
                    <span class="form-icon">‚ûï</span>
                    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
                </h3>
            </div>
            <div class="form-card-body">
                <EditForm Model="@createRequest" OnValidSubmit="HandleCreate">
                    <DataAnnotationsValidator />
                    <div class="form-grid">
                        <div class="form-group modern-form-group form-group-full">
                            <label class="form-label modern-label">
                                –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
                                <span class="required-mark">*</span>
                            </label>
                            <InputSelect @bind-Value="createRequest.Kind" class="form-control modern-input" @onchange="OnKindChanged">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                <option value="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
                                <option value="furniture">–ú–µ–±–µ–ª—å</option>
                                <option value="software">–ü–û</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => createRequest.Kind)" />
                        </div>
                        <div class="form-group modern-form-group form-group-full">
                            <label class="form-label modern-label">
                                –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
                                <span class="required-mark">*</span>
                            </label>
                            <InputText @bind-Value="createRequest.Name" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞" />
                            <ValidationMessage For="@(() => createRequest.Name)" />
                        </div>
                        <div class="form-group modern-form-group form-group-full">
                            <label class="form-label modern-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <InputTextArea @bind-Value="createRequest.Description" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞" rows="3" />
                            <ValidationMessage For="@(() => createRequest.Description)" />
                        </div>
                        <div class="form-group modern-form-group">
                            <label class="form-label modern-label">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                                <span class="required-mark">*</span>
                            </label>
                            <InputNumber @bind-Value="createRequest.Quantity" class="form-control modern-input" placeholder="0" />
                            <ValidationMessage For="@(() => createRequest.Quantity)" />
                        </div>
                        <div class="form-group modern-form-group">
                            <label class="form-label modern-label">
                                –î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
                                <span class="required-mark">*</span>
                            </label>
                            <InputDate @bind-Value="receivedDate" class="form-control modern-input" />
                            <ValidationMessage For="@(() => createRequest.ReceivedDate)" />
                        </div>
                        <div class="form-group modern-form-group">
                            <label class="form-label modern-label">
                                –°–æ—Å—Ç–æ—è–Ω–∏–µ
                                <span class="required-mark">*</span>
                            </label>
                            <InputSelect @bind-Value="createRequest.State" class="form-control modern-input">
                                <option value="0">–í —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏</option>
                                <option value="1">–°–ø–∏—Å–∞–Ω–æ</option>
                                <option value="2">–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => createRequest.State)" />
                        </div>
                    </div>

                    @if (createRequest.Kind == "equipment")
                    {
                        <div class="form-section modern-form-section">
                            <h6 class="form-section-title">üîß –î–∞–Ω–Ω—ã–µ –æ–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏</h6>
                            <div class="form-grid">
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">
                                        –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä
                                        <span class="required-mark">*</span>
                                    </label>
                                    <InputText @bind-Value="createRequest.SerialNumber" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä" />
                                </div>
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">
                                        –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                                        <span class="required-mark">*</span>
                                    </label>
                                    <InputText @bind-Value="createRequest.Location" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" />
                                </div>
                                <div class="form-group modern-form-group form-group-full">
                                    <label class="form-label modern-label">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</label>
                                    <InputTextArea @bind-Value="createRequest.TechnicalCharacteristics" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏" rows="2" />
                                </div>
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">–ù–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    <InputText @bind-Value="createRequest.ClassroomNumber" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏" />
                                </div>
                            </div>
                        </div>
                    }

                    @if (createRequest.Kind == "furniture")
                    {
                        <div class="form-section modern-form-section">
                            <h6 class="form-section-title">ü™ë –î–∞–Ω–Ω—ã–µ –æ –º–µ–±–µ–ª–∏</h6>
                            <div class="form-grid">
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">
                                        –¢–∏–ø –º–µ–±–µ–ª–∏
                                        <span class="required-mark">*</span>
                                    </label>
                                    <InputText @bind-Value="createRequest.Type" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –º–µ–±–µ–ª–∏" />
                                </div>
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                                    <InputText @bind-Value="createRequest.Material" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª" />
                                </div>
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">
                                        –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                                        <span class="required-mark">*</span>
                                    </label>
                                    <InputText @bind-Value="createRequest.Location" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" />
                                </div>
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">–ù–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    <InputText @bind-Value="createRequest.ClassroomNumber" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏" />
                                </div>
                            </div>
                        </div>
                    }

                    @if (createRequest.Kind == "software")
                    {
                        <div class="form-section modern-form-section">
                            <h6 class="form-section-title">üíª –î–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–º –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–∏</h6>
                            <div class="form-grid">
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">
                                        –í–µ—Ä—Å–∏—è
                                        <span class="required-mark">*</span>
                                    </label>
                                    <InputText @bind-Value="createRequest.Version" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–µ—Ä—Å–∏—é" />
                                </div>
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">
                                        –õ–∏—Ü–µ–Ω–∑–∏—è
                                        <span class="required-mark">*</span>
                                    </label>
                                    <InputText @bind-Value="createRequest.License" class="form-control modern-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏–ø –ª–∏—Ü–µ–Ω–∑–∏–∏" />
                                </div>
                                <div class="form-group modern-form-group">
                                    <label class="form-label modern-label">
                                        –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏
                                        <span class="required-mark">*</span>
                                    </label>
                                    <InputDate @bind-Value="licenseExpirationDate" class="form-control modern-input" />
                                </div>
                            </div>
                        </div>
                    }

                    <div class="form-actions modern-form-actions">
                        <button type="submit" class="btn btn-primary btn-submit">
                            <span>‚úì</span> –°–æ–∑–¥–∞—Ç—å
                        </button>
                        <button type="button" class="btn btn-secondary btn-cancel" @onclick="CancelForm">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    <div class="data-card modern-card">
        <div class="data-card-header">
            <div class="data-card-title-section">
                <h3 class="data-card-title">
                    <span class="data-icon">üìã</span>
                    –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
                </h3>
                <span class="data-count">–í—Å–µ–≥–æ: @filteredItems.Count</span>
            </div>
            <div class="filter-container-modern">
                <label class="filter-label-modern">–§–∏–ª—å—Ç—Ä:</label>
                <select class="form-control modern-input filter-select-modern" value="@selectedKind" @onchange="OnFilterChanged">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
                    <option value="furniture">–ú–µ–±–µ–ª—å</option>
                    <option value="software">–ü–û</option>
                </select>
            </div>
        </div>
        <div class="data-card-body">
            @if (filteredItems.Count == 0 && !isLoading)
            {
                <div class="empty-state modern-empty">
                    <div class="empty-icon">üì≠</div>
                    <p class="empty-text">–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <p class="empty-hint">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</p>
                </div>
            }
            else
            {
                <div class="table-container">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>–¢–∏–ø</th>
                                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th class="text-center">–ö–æ–ª-–≤–æ</th>
                                <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
                                <th>–ê—É–¥–∏—Ç–æ—Ä–∏—è</th>
                                <th>–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
                                <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in filteredItems)
                            {
                                <tr class="table-row">
                                    <td>
                                        <span class="badge badge-item-type">@GetItemKindName(item)</span>
                                    </td>
                                    <td class="table-cell-primary">
                                        <strong>@item.Name</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-count">@item.Quantity</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-state">@GetStateName(item.State)</span>
                                    </td>
                                    <td>
                                        <span style="color: #6c757d;">@GetClassroomNumber(item)</span>
                                    </td>
                                    <td>
                                        <span style="color: #6c757d;">@item.ReceivedDate.ToString("dd.MM.yyyy")</span>
                                    </td>
                                    <td class="table-actions">
                                        <button class="btn btn-icon btn-delete" @onclick="() => DeleteItem(item.Id)" title="–£–¥–∞–ª–∏—Ç—å">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<MaterialItemDto> items = new();
    private List<MaterialItemDto> filteredItems = new();
    private bool showCreateForm = false;
    private CreateMaterialItemRequest createRequest = new();
    private DateTime? receivedDate = DateTime.UtcNow;
    private DateTime? licenseExpirationDate = null;
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading = false;
    private string selectedKind = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadItems();
    }

    private async Task LoadItems()
    {
        isLoading = true;
        try
        {
            items = await MaterialItemsApi.GetAllAsync();
            ApplyFilter();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilter()
    {
        if (!string.IsNullOrEmpty(selectedKind))
        {
            filteredItems = items.Where(i => GetItemKind(i).ToLowerInvariant() == selectedKind.ToLowerInvariant()).ToList();
        }
        else
        {
            filteredItems = items;
        }
    }

    private void FilterChanged()
    {
        ApplyFilter();
    }

    private void OnFilterChanged(ChangeEventArgs e)
    {
        selectedKind = e.Value?.ToString() ?? "";
        ApplyFilter();
    }

    private void OnKindChanged(ChangeEventArgs e)
    {
        createRequest.Kind = e.Value?.ToString() ?? "";
        KindChanged();
    }

    private string GetItemKind(MaterialItemDto item)
    {
        if (!string.IsNullOrEmpty(item.ItemType))
        {
            return item.ItemType.ToLowerInvariant();
        }
        return item switch
        {
            EquipmentDto => "equipment",
            FurnitureDto => "furniture",
            SoftwareDto => "software",
            _ => ""
        };
    }

    private string GetItemKindName(MaterialItemDto item)
    {
        if (!string.IsNullOrEmpty(item.ItemType))
        {
            return item.ItemType.ToLowerInvariant() switch
            {
                "equipment" => "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                "furniture" => "–ú–µ–±–µ–ª—å",
                "software" => "–ü–û",
                _ => "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            };
        }
        return item switch
        {
            EquipmentDto => "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
            FurnitureDto => "–ú–µ–±–µ–ª—å",
            SoftwareDto => "–ü–û",
            _ => "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        };
    }

    private string GetStateName(State state)
    {
        return state switch
        {
            State.Operational => "–í —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏",
            State.WrittenOff => "–°–ø–∏—Å–∞–Ω–æ",
            State.UnderRepair => "–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ",
            _ => state.ToString()
        };
    }

    private string GetClassroomNumber(MaterialItemDto item)
    {
        return item switch
        {
            EquipmentDto eq => eq.ClassroomNumber ?? "-",
            FurnitureDto fu => fu.ClassroomNumber ?? "-",
            _ => "-"
        };
    }

    private void ShowCreateForm()
    {
        showCreateForm = true;
        createRequest = new CreateMaterialItemRequest
        {
            ReceivedDate = DateTime.UtcNow,
            State = 0
        };
        receivedDate = DateTime.UtcNow;
        licenseExpirationDate = null;
        errorMessage = null;
        successMessage = null;
    }

    private void KindChanged()
    {
        // Clear kind-specific fields when kind changes
        createRequest.SerialNumber = null;
        createRequest.Location = null;
        createRequest.TechnicalCharacteristics = null;
        createRequest.Type = null;
        createRequest.Material = null;
        createRequest.Version = null;
        createRequest.License = null;
        createRequest.LicenseExpirationDate = null;
        licenseExpirationDate = null;
    }

    private async Task HandleCreate()
    {
        try
        {
            if (receivedDate.HasValue)
            {
                createRequest.ReceivedDate = receivedDate.Value;
            }
            if (licenseExpirationDate.HasValue && createRequest.Kind == "software")
            {
                createRequest.LicenseExpirationDate = licenseExpirationDate.Value;
            }
            await MaterialItemsApi.CreateAsync(createRequest);
            successMessage = "–û–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!";
            errorMessage = null;
            showCreateForm = false;
            createRequest = new CreateMaterialItemRequest();
            receivedDate = DateTime.UtcNow;
            licenseExpirationDate = null;
            await LoadItems();
        }
        catch (Exception ex)
        {
            errorMessage = $"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç: {ex.Message}";
            successMessage = null;
        }
    }

    private async Task DeleteItem(Guid id)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç?"))
            return;

        try
        {
            await MaterialItemsApi.DeleteAsync(id);
            successMessage = "–û–±—ä–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!";
            errorMessage = null;
            await LoadItems();
        }
        catch (Exception ex)
        {
            errorMessage = $"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç: {ex.Message}";
            successMessage = null;
        }
    }

    private void CancelForm()
    {
        showCreateForm = false;
        createRequest = new CreateMaterialItemRequest();
        receivedDate = DateTime.UtcNow;
        licenseExpirationDate = null;
        errorMessage = null;
        successMessage = null;
    }
}
